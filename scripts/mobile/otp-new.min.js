(function(c){function k(d){return d&&"[object Function]"===a.call(d)}function g(a){var f=function(){};f.prototype=a;return new f}function n(a,f){var y=b[a];return y&&y.test(f)?!0:p[a]}function l(a,f){this.cfg=g(m);for(var b in f)f.hasOwnProperty(b)&&f[b]&&(this.cfg[b]=f[b]);if(!a)throw Error("\u6211\u4eec\u5fc5\u987b\u63d0\u4f9bOtp ImageCode \u7684\u670d\u52a1\u5b9e\u4f8b\uff01");this.handlers={};this.receiver=null;this.service=a;var h,c=function(a,d){h=setTimeout(function(){a.fireEvent("showTicker",
d);d-=1;0<d?c(a,d):(d=0,a.fireEvent("closeTicker",d))},m.timeout)};this._startTicker=function(a,d){h&&(clearTimeout(h),h=0);d=d||this.cfg.tickerSecond||60;c(a,d)}}var b={phone:/^1[3-9][0-9]\d{8}$/,mobile:/^1[3-9][0-9]\d{8}$/,trim:/^\s+|\s+$/g},p={common:"\u7cfb\u7edf\u5185\u90e8\u9519\u8bef",phone:"\u624b\u673a\u53f7\u7801\u683c\u5f0f\u9519\u8bef",mobile:"\u624b\u673a\u53f7\u7801\u683c\u5f0f\u9519\u8bef"},a=Object.prototype.toString,m={timeout:1E3,trySendOTPServiceName:"trySendOTP",ignoreMobileValidation:!1,
tickerSecond:60};l.prototype={constructor:l,addHandler:function(a,f){"undefined"==typeof this.handlers[a]&&(this.handlers[a]=[]);k(f)&&this.handlers[a].push(f)},addReceiver:function(a){this.receiver=a},removeHandler:function(a,f){if(this.handlers[a]instanceof Array){for(var b=this.handlers[a],h=0,m=b.length;h<m&&b[h]!==f;h++);b.splice(h,1)}},fire:function(a){a.target||(a.target=this);if(this.receiver)if(k(this.receiver))this.receiver(a);else throw Error("`receiver`\u63a5\u6536\u5668\u5fc5\u987b\u662f\u4e00\u4e2a\u51fd\u6570\uff01");
else if(this.handlers[a.type]instanceof Array)for(var f=this.handlers[a.type],b=0,h=f.length;b<h;b++)f[b](a)},fireEvent:function(a,b){this.fire({type:a,data:b||null})},fireError:function(a,b){this.fireEvent("error",{code:a,message:b})},isMobile:function(a){return n("mobile",a)},trySendOTP:function(a,b,m,h){if(!this.cfg.ignoreMobileValidation){var c=n("phone",a);if(!0!==c){this.fireError("mobile_invalid",c);return}}this.fireEvent("OTPSending");var e=this,c=this.service[this.cfg.trySendOTPServiceName];
k(c)?c.call(this.service,a,b,m,h,function(a){var b=a.data,f=a.code;switch(f){case "000000":e.fireEvent("OTPSentSuccess",b);a=0;isNaN(b.retrySeconds)||(a=parseInt(b.retrySeconds));e._startTicker(e,a);break;case "000001":if(b=b.captcha)e.fireEvent("captchaShow",b);else throw Error("\u5f53\u524d\u670d\u52a1\u5668\u7aef\u672a\u4f20\u56deCaptha\u5bf9\u8c61");break;default:e.fireError(f,a.message)}}):this.fireError("try_send_otp_service_undefined","\u81ea\u5b9a\u4e49\u4e1a\u52a1trySendOTP()\u4e0d\u662f\u4e00\u4e2a\u51fd\u6570")},
refreshCaptcha:function(a){var b=this;this.service.refreshCaptcha(a,function(a){var c=a.data;switch(a.code){case "000000":b.fireEvent("captchaRefreshed",c.captcha);break;default:b.fireError("captcha_refreshed_failed",a.message)}})},verifyCaptcha:function(a,b){var c=this;this.service.verifyCaptcha(a,b,function(a){var b=a.data;switch(a.code){case "000000":c.fireEvent("tokenFlushed",b.captchaToken);break;default:c.fireError("token_flushed_failed",a.message)}})}};c.OtpImageSuite=l})(window);
(function(c){function k(a){/^(ftp|http|https):\/\/[^ "]+$/.test(a)||(a=this.apiRoot+a);return a}var g=function(a){var b={};this.isMtp?(_newResult={},c.extend(_newResult,a),delete _newResult.resultCode,delete _newResult.resultMsg,b.code=a.resultCode,b.message=a.resultMsg,b.data=_newResult,"1000"==b.code&&(b.code="000000")):(b.code=a.code,b.message=a.message,b.data=a.data);return b},n=function(a){a=g.call(this,a);"000000"!=a.code&&"000000"!=a.code&&"1184"==a.code&&(a.code="000001",a.data={captcha:{captchaId:a.data.captchaId,
captchaUrl:a.data.captchaUrl}});return a},l=function(a){a=g.call(this,a);"000000"==a.code&&(a.data={captcha:{captchaId:a.data.captchaId,captchaUrl:a.data.captchaUrl}});return a},b=function(a){a=g.call(this,a);"000000"==a.code&&(a.data={captchaToken:a.data});return a},p={apiRoot:"http://localhost:1100",trySendOTPApi:"",isMtp:!0,dtos:{baseAjaxDto:g,baseAjaxTrySendOTPDto:n,baseAjaxRefreshCaptchaDto:l,baseAjaxVerifyCaptchaDto:b},trySendOTP:function(a,b,d,f,g){a={phone:a};b&&(a.captchaToken=b);d&&(a.deviceId=
d);c.extend(a,f);c.ajax({url:k.call(this,this.trySendOTPApi||"/selfcenter/changeSendOtp"),contentType:"application/json",type:"POST",dataType:"json",data:JSON.stringify(a),processData:!1}).then(function(a){g&&g(n.call(p,a))},function(a){throw Error("status code:"+a.status);})},refreshCaptcha:function(a,b){var d={};c.extend(d,a);c.ajax({url:k.call(this,"/goutong/refreshCaptcha"),contentType:"application/json",type:"POST",dataType:"json",data:JSON.stringify(d),processData:!1}).then(function(a){b&&b(l.call(p,
a))},function(a){throw Error("status code:"+a.status);})},verifyCaptcha:function(a,g,d){c.extend(a,g);c.ajax({url:k.call(this,"/goutong/verifyCaptcha"),contentType:"application/json",type:"POST",dataType:"json",data:JSON.stringify(a),processData:!1}).then(function(a){d&&d(b.call(p,a))},function(a){throw Error("status code:"+a.status);})}};window.PafOtpAPI=p})($);
(function(c){var k=window.OtpImageSuite,g=window.PafOtpAPI,n={autoSendOtp:!1,firstShowCaptcha:!1,leftSecondFormatter:"{0}s",dataCaptchaId:"captchaId",dataCaptchaToken:"captchaToken",mobileInputSelector:".mobile-input-selector",captchaControlSelector:"captcha-control-selector",captchaInputSelector:".captcha-input-selector",captchaImageSelector:".captcha-image-selector",otpGetSelector:".otp-get-btn-selector",otpInputSelector:".otp-input-selector",otpTickerSelector:".ticker-selector",eventListener:function(b){},
otpHasPassedCallback:function(b){},otpErrorsCallback:function(b){},getExtraData:function(){return null}},l=function(b,g,a){function m(a){a?(v.prop("disabled",!0),w.prop("disabled",!0)):(v.prop("disabled",!1),w.prop("disabled",!1))}function d(a){var c=a.data;a=c.code;var c=c.message,d=e.otpErrorsCallback||function(){};switch(a){case "mobile_invalid":d(a,c);break;case "captcha_refreshed_failed":d(a,c);break;case "token_flushed_failed":b.data(e.dataCaptchaToken,null);d(a,c);break;default:d(a,c)}}function f(a){q=
!1;m(!1);x.css("display","block");s.css("display","none");s.html("")}function l(a){z.attr("src",a.captchaUrl?a.captchaUrl+"?r="+Math.random():"");b.data(e.dataCaptchaId,a.captchaId||null)}function h(){var a=v.val(),d=b.data(e.dataCaptchaToken),f=c.extend({},e.getExtraData()||{});t.trySendOTP(a,d,"",f)}function u(){q||t.refreshCaptcha()}b=c(b);if(!b||!b.length)throw Error("the context parameter required!");var e=c.extend({},n,a),q=!1,v=b.find(e.mobileInputSelector),r=b.find(e.captchaControlSelector),
w=b.find(e.captchaInputSelector),z=b.find(e.captchaImageSelector),x=b.find(e.otpGetSelector);b.find(e.otpInputSelector);var s=b.find(e.otpTickerSelector),t=new k(g,{trySendOTPServiceName:e.trySendOtpServiceName,ignoreMobileValidation:e.ignoreMobileValidation});(function(){x.on("click",function(a){h()});w.on("input",function(a){(a=c.trim(c(this).val()))&&4<=a.length&&t.verifyCaptcha({captchaInput:a,captchaId:b.data(e.dataCaptchaId)})});z.on("click",function(){u()})})();(function(){t.addReceiver(function(a){var c=
a.type,g=a.data;e.eventListener&&e.eventListener(a);switch(c){case "OTPSentSuccess":m(!0);e.otpHasPassedCallback&&e.otpHasPassedCallback({data:g});break;case "error":d(a);break;case "showTicker":q=!0;x.css("display","none");s.css("display","block");s.html(e.leftSecondFormatter.replace(/\{0\}/g,g));break;case "closeTicker":f(g);break;case "captchaShow":r.css("display","block");l(g);break;case "captchaRefreshed":l(g);break;case "tokenFlushed":b.data(e.dataCaptchaToken,g||null),e.autoSendOtp&&h()}})})();
e.firstShowCaptcha&&(u(),r.css("display","block"));b.data("start",function(){h()});b.data("reset",function(){q=!1;f();e.firstShowCaptcha?r.css("display","block"):r.css("display","none")});b.data("refreshCaptcha",u)};c.fn.otpNew=function(b){return this.each(function(){var k=c(this);c.extend(g,b.otpService);delete b.otpService;l(k,g,b)})}})($);